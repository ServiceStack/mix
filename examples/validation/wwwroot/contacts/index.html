{{ 'requires-auth' | partial }}

<h3 class="py-2">Add new Contact</h3>

<form action="/contacts" method="post" class="col-lg-4">
    <div class="form-group" data-validation-summary="title,name,color,filmGenres,age,agree"></div>

    <div class="form-group">
        <div class="form-check">
            {{#each contactTitles}}
            <div class="custom-control custom-radio custom-control-inline">
                <input type="radio" id="title-{{Key}}" name="title" value="{{Key}}" class="custom-control-input">
                <label class="custom-control-label" for="title-{{Key}}">{{Value}}</label>
            </div>
            {{/each}}
        </div>
    </div>
    <div class="form-group">
        <label for="name">Full Name</label>
        <input class="form-control" id="name" name="name" type="text" placeholder="Name">
        <small id="name-help" class="text-muted">Your first and last name</small>
    </div>
    <div class="form-group">
        <label class="form-label" for="color">Favorite color</label>
        <select id="color" name="color" class="col-6 form-control">
            <option value=""></option>
            {{#each contactColors}}
                <option value="{{Key}}">{{Value}}</option>
            {{/each}}
        </select>
    </div>
    <div class="form-group">
        <label class="form-check-label">Favorite Film Genres</label>
        <div class="form-check">
        {{#each contactGenres}}
            <div class="custom-control custom-checkbox">
                <input type="checkbox" id="filmGenres-{{it}}" name="filmGenres" value="{{it}}" class="form-check-input">
                <label class="form-check-label" for="filmGenres-{{it}}">{{it}}</label>
            </div>
        {{/each}}
        </div>
    </div>
    <div class="form-group">
        <input class="form-control col-4" name="age" type="number" min="13" placeholder="Age">
    </div>
    <div class="form-group">
        <div class="form-check">
            <input class=" form-check-input" id="agree" name="agree" type="checkbox" value="true">
            <label class="form-check-label" for="agree">Agree to terms and conditions</label>
        </div>
    </div>
    <div class="form-group">
        <button class="btn btn-primary" type="submit">Add Contact</button>
        <a class="btn outline-secondary" data-click="reset">reset</a>
    </div>
</form>

<table id="results"></table>

{{ htmlError }}

<script>var CONTACTS = {{ sendToGateway('GetContacts') | map => it.Results | json }};</script>

{{#raw appendTo scripts}}
<script>!window["@servicestack/client"] && document.write(unescape('%3Cscript src="https://unpkg.com/@servicestack/client/dist/servicestack-client.umd.js"%3E%3C/script%3E'));</script>
<script>
(function(_){

    // Copied from dtos.ts generated by https://docs.servicestack.net/typescript-add-servicestack-reference
    // @Route("/contacts", "GET")
    var GetContacts = /** @class */ (function () {
        function GetContacts(init) {
            Object.assign(this, init);
        }
        GetContacts.prototype.createResponse = function () { return new GetContactsResponse(); };
        GetContacts.prototype.getTypeName = function () { return 'GetContacts'; };
        return GetContacts;
    }());
    var GetContactsResponse = /** @class */ (function () {
        function GetContactsResponse(init) {
            Object.assign(this, init);
        }
        return GetContactsResponse;
    }());
    // @Route("/contacts/{Id}", "GET")
    var GetContact = /** @class */ (function () {
        function GetContact(init) {
            Object.assign(this, init);
        }
        GetContact.prototype.createResponse = function () { return new GetContactResponse(); };
        GetContact.prototype.getTypeName = function () { return 'GetContact'; };
        return GetContact;
    }());
    // @Route("/contacts/{Id}", "DELETE")
    // @Route("/contacts/{Id}/delete", "POST")
    var DeleteContact = /** @class */ (function () {
        function DeleteContact(init) {
            Object.assign(this, init);
        }
        DeleteContact.prototype.createResponse = function () { };
        DeleteContact.prototype.getTypeName = function () { return 'DeleteContact'; };
        return DeleteContact;
    }());

    var client = new _.JsonServiceClient();

    var form = document.querySelector("form");
    _.bootstrapForm(form,{
        success: function (r) {
            form.reset();
            CONTACTS.push(r.result);
            render();
        }
    });

    _.bindHandlers({
        reset: function() {
            document.querySelector('form').reset();
        },
        deleteContact: function(id) {
            if (!confirm('Are you sure?'))
                return;

            client.delete(new DeleteContact({ id:id }))
                .then(function() {
                    client.get(new GetContacts())
                        .then(function(r){
                            CONTACTS = r.results;
                            render();
                        })
                });
        }
    });

    function contactRow(contact)
    {
        return '<tr style="background:' + contact.color + '">' +
            '<td class="p-2">' + contact.title + ' ' + contact.name + ' (' + contact.age + ')</td>' +
            '<td class="p-2"><a href="/contacts/' + contact.id + '/edit">edit</a></td>' +
            '<td class="p-2"><button class="btn btn-sm btn-primary" data-click="deleteContact:' + contact.id + '">delete</button></td>' +
        '</tr>';
    }

    function render() {
        var sb = "";
        if (CONTACTS.length > 0) {
            for (let i=0; i<CONTACTS.length; i++) {
                sb += contactRow(CONTACTS[i])
            }
        } else {
            sb = "<tr><td>There are no contacts.</td></tr>";
        }
        document.querySelector("#results").innerHTML = '<tbody>' + sb + '</tbody>';
    }
    render();

})(window["@servicestack/client"]);
</script>
{{/raw}}
